{% extends "base.html" %}
{% block title %}{{title}}{% endblock title %}

{% block content %}
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Three.js, Chart.js –∏ Leaflet (OpenStreetMap) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stats-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .stats-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .period-selector {
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .period-btn {
        margin: 0 5px;
        border-radius: 25px;
        padding: 8px 20px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .period-btn.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
        color: #333;
        margin-bottom: 1rem;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .big-number {
        font-size: 3rem;
        font-weight: 800;
        color: #0d6efd;
        text-align: center;
        margin: 1rem 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .container-3d {
        height: 300px;
        border-radius: 10px;
        overflow: hidden;
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        position: relative;
    }
    
    .chart-container {
        height: 250px;
        position: relative;
    }
    
    .category-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 1rem;
    }
    
    .category-item {
        text-align: center;
        padding: 1rem;
        border-radius: 10px;
        background: rgba(13, 110, 253, 0.1);
        margin: 0 5px;
        flex: 1;
    }
    
    .category-item h4 {
        margin: 0;
        color: #0d6efd;
        font-size: 1rem;
    }
    
    .category-item p {
        margin: 5px 0 0 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
    }
    
    .floating-elements {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
    }
    
    .floating-circle {
        position: absolute;
        border-radius: 50%;
        background: rgba(13, 110, 253, 0.1);
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    .loading {
        text-align: center;
        color: #666;
        font-size: 1rem;
        margin: 50px 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è OpenStreetMap –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω */
    .custom-popup .leaflet-popup-content-wrapper {
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .custom-popup .leaflet-popup-content {
        margin: 0;
        padding: 0;
    }
    
    .custom-popup .leaflet-popup-tip {
        background: white;
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
</style>

<!-- –ü–ª–∞–≤–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ–Ω–∞ -->
<div class="floating-elements">
    <div class="floating-circle" style="width: 80px; height: 80px; top: 10%; left: 10%; animation-delay: 0s;"></div>
    <div class="floating-circle" style="width: 120px; height: 120px; top: 20%; right: 10%; animation-delay: 2s;"></div>
    <div class="floating-circle" style="width: 60px; height: 60px; bottom: 20%; left: 20%; animation-delay: 4s;"></div>
    <div class="floating-circle" style="width: 100px; height: 100px; bottom: 10%; right: 20%; animation-delay: 1s;"></div>
</div>

<div class="stats-header">
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂–∞–ª–æ–±</h1>
    <p class="mb-0">{{ title }}</p>
</div>

<!-- –°–µ–ª–µ–∫—Ç–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
<div class="period-selector">
    <a href="{% url 'web:reports_period' 'day' %}" class="btn btn-outline-primary period-btn {% if '–¥–µ–Ω—å' in title %}active{% endif %}">–î–µ–Ω—å</a>
    <a href="{% url 'web:reports_period' 'week' %}" class="btn btn-outline-primary period-btn {% if '–Ω–µ–¥–µ–ª—é' in title %}active{% endif %}">–ù–µ–¥–µ–ª—è</a>
    <a href="{% url 'web:reports_period' 'month' %}" class="btn btn-outline-primary period-btn {% if '–º–µ—Å—è—Ü' in title %}active{% endif %}">–ú–µ—Å—è—Ü</a>
    <a href="{% url 'web:reports_period' 'year' %}" class="btn btn-outline-primary period-btn {% if '–≥–æ–¥' in title %}active{% endif %}">–ì–æ–¥</a>
    <a href="{% url 'web:reports_period' 'all' %}" class="btn btn-outline-primary period-btn {% if '–í—Å–µ' in title %}active{% endif %}">–í—Å–µ –≤—Ä–µ–º—è</a>
</div>

<div class="row">
    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <h3>üìà –í—Å–µ–≥–æ –∂–∞–ª–æ–±</h3>
            <div class="big-number">{{ count }}</div>
            <p class="text-center text-muted">–∑–∞ –ø–µ—Ä–∏–æ–¥</p>
        </div>
    </div>
    
    <!-- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <h3>‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</h3>
            <div class="big-number">{{ avg_time }}</div>
            <p class="text-center text-muted">—á–∞—Å–æ–≤</p>
        </div>
    </div>
    
    <!-- –ü—Ä–æ—Ü–µ–Ω—Ç —Ä–µ—à—ë–Ω–Ω—ã—Ö -->
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <h3>‚úÖ –†–µ—à–µ–Ω–æ</h3>
            <div class="big-number">{{ resolved_percent }}</div>
            <p class="text-center text-muted">%</p>
        </div>
    </div>
    
    <!-- –í –æ–±—Ä–∞–±–æ—Ç–∫–µ -->
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <h3>‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</h3>
            <div class="big-number">{{ pending_count }}</div>
            <p class="text-center text-muted">–∂–∞–ª–æ–±</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—É -->
    <div class="col-lg-4 col-md-6">
        <div class="stat-card">
            <h3>üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</h3>
            <div class="big-number">{{ kazakhstan_count }}</div>
            <p class="text-center text-muted">–∂–∞–ª–æ–± –Ω–∞ –∫–∞—Ä—Ç–µ</p>
        </div>
    </div>
    
    <!-- –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ -->
    <div class="col-lg-4 col-md-6">
        <div class="stat-card">
            <h3>üïê –ó–∞ 24 —á–∞—Å–∞</h3>
            <div class="big-number">{{ last_24h_count }}</div>
            <p class="text-center text-muted">–Ω–æ–≤—ã—Ö –∂–∞–ª–æ–±</p>
        </div>
    </div>
    
    <!-- –†–µ—à—ë–Ω–Ω—ã–µ –∂–∞–ª–æ–±—ã -->
    <div class="col-lg-4 col-md-6">
        <div class="stat-card">
            <h3>‚úÖ –†–µ—à—ë–Ω–Ω—ã–µ</h3>
            <div class="big-number">{{ decided_count }}</div>
            <p class="text-center text-muted">–∂–∞–ª–æ–±</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- 3D –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
    <div class="col-lg-8 col-md-6">
        <div class="stat-card">
            <h3>üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
            <div class="container-3d" id="3d-pie-chart">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ 3D –º–æ–¥–µ–ª–∏...</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 3D —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
    <div class="col-lg-6 col-md-6">
        <div class="stat-card">
            <h3>üìä –î–∏–Ω–∞–º–∏–∫–∞ –∂–∞–ª–æ–±</h3>
            <div class="container-3d" id="3d-bar-chart">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ 3D –º–æ–¥–µ–ª–∏...</div>
            </div>
        </div>
    </div>
    
    <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
    <div class="col-lg-6 col-md-6">
        <div class="stat-card">
            <h3>üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="category-stats">
                <div class="category-item">
                    <h4>üö® –í–∞–∂–Ω—ã–µ</h4>
                    <p id="critical-count">0</p>
                </div>
                <div class="category-item">
                    <h4>üìù –û–±—ã—á–Ω—ã–µ</h4>
                    <p id="secondary-count">0</p>
                </div>
                <div class="category-item">
                    <h4>üóëÔ∏è –°–ø–∞–º</h4>
                    <p id="spam-count">0</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- OpenStreetMap —Å —Ç–æ—á–∫–∞–º–∏ –∂–∞–ª–æ–± -->
    <div class="col-lg-6 col-md-6">
        <div class="stat-card">
            <h3>üó∫Ô∏è –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∂–∞–ª–æ–±</h3>
            <div id="openstreetmap" style="height: 400px; width: 100%; border-radius: 10px; overflow: hidden;">
                <div class="loading" style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa;">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...
                </div>
            </div>
            <!-- –õ–µ–≥–µ–Ω–¥–∞ –¥–ª—è –∫–∞—Ä—Ç—ã -->
            <div class="mt-3">
                <div class="d-flex justify-content-center flex-wrap">
                    <div class="mx-2 mb-1">
                        <span style="display: inline-block; width: 12px; height: 12px; background-color: #ff4444; border-radius: 50%; margin-right: 5px;"></span>
                        <small>–í–∞–∂–Ω—ã–µ</small>
                    </div>
                    <div class="mx-2 mb-1">
                        <span style="display: inline-block; width: 12px; height: 12px; background-color: #44ff44; border-radius: 50%; margin-right: 5px;"></span>
                        <small>–û–±—ã—á–Ω—ã–µ</small>
                    </div>
                    <div class="mx-2 mb-1">
                        <span style="display: inline-block; width: 12px; height: 12px; background-color: #4444ff; border-radius: 50%; margin-right: 5px;"></span>
                        <small>–°–ø–∞–º</small>
                    </div>
                </div>
                <small class="text-muted d-block text-center mt-2">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</small>
            </div>
        </div>
    </div>
    
    <!-- –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–¥–æ–≤ -->
    <div class="col-lg-6 col-md-6">
        <div class="stat-card">
            <h3>üìà –¢—Ä–µ–Ω–¥—ã</h3>
            <div class="chart-container">
                <canvas id="trend-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div style="text-align: center; margin-top: 2rem;">
    <a href="{% url 'web:sos_stats' 'all' %}" class="btn btn-outline-danger" style="margin: 0 10px;">
        üö® SOS –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </a>
    <a href="{% url 'web:reports_period' 'all' %}" class="btn btn-outline-secondary" style="margin: 0 10px;">
        üìã Report –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </a>
</div>

<script>
// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Django
const criticalCount = parseInt('{{ critical_count }}');
const secondaryCount = parseInt('{{ secondary_count }}');
const spamCount = parseInt('{{ spam_count }}');
const totalCount = parseInt('{{ count }}');

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
document.getElementById('critical-count').textContent = criticalCount;
document.getElementById('secondary-count').textContent = secondaryCount;
document.getElementById('spam-count').textContent = spamCount;

// 3D –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
function create3DPieChart() {
    const container = document.getElementById('3d-pie-chart');
    container.innerHTML = '';
    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setClearColor(0x000000, 0);
    container.appendChild(renderer.domElement);
    
    // –°–æ–∑–¥–∞–µ–º 3D —Å–µ–≥–º–µ–Ω—Ç—ã
    const segments = [
        { count: criticalCount, color: 0xff4444, label: '–í–∞–∂–Ω—ã–µ' },
        { count: secondaryCount, color: 0x44ff44, label: '–û–±—ã—á–Ω—ã–µ' },
        { count: spamCount, color: 0x4444ff, label: '–°–ø–∞–º' }
    ];
    
    const group = new THREE.Group();
    let angle = 0;
    
    segments.forEach((segment, index) => {
        if (segment.count > 0) {
            const geometry = new THREE.CylinderGeometry(0.4, 0.4, 0.1, 32);
            const material = new THREE.MeshPhongMaterial({ color: segment.color });
            const cylinder = new THREE.Mesh(geometry, material);
            
            const segmentAngle = (segment.count / totalCount) * Math.PI * 2;
            cylinder.rotation.z = angle;
            cylinder.position.x = Math.cos(angle + segmentAngle/2) * 0.3;
            cylinder.position.y = Math.sin(angle + segmentAngle/2) * 0.3;
            
            group.add(cylinder);
            angle += segmentAngle;
        }
    });
    
    scene.add(group);
    
    // –û—Å–≤–µ—â–µ–Ω–∏–µ
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 5, 5);
    scene.add(light);
    
    const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
    scene.add(ambientLight);
    
    camera.position.z = 2.5;
    
    // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        group.rotation.y += 0.005;
        renderer.render(scene, camera);
    }
    
    animate();
}

// 3D —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
function create3DBarChart() {
    const container = document.getElementById('3d-bar-chart');
    container.innerHTML = '';
    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setClearColor(0x000000, 0);
    container.appendChild(renderer.domElement);
    
    const group = new THREE.Group();
    const heights = [criticalCount, secondaryCount, spamCount];
    const colors = [0xff4444, 0x44ff44, 0x4444ff];
    
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª
    const maxHeight = Math.max(...heights);
    const scaleFactor = maxHeight > 1000 ? 0.0001 : maxHeight > 100 ? 0.001 : 0.01;
    
    heights.forEach((height, index) => {
        if (height > 0) {
            const scaledHeight = height * scaleFactor;
            const geometry = new THREE.BoxGeometry(0.25, scaledHeight, 0.25);
            const material = new THREE.MeshPhongMaterial({ color: colors[index] });
            const bar = new THREE.Mesh(geometry, material);
            
            bar.position.x = (index - 1) * 0.4;
            bar.position.y = scaledHeight / 2;
            
            group.add(bar);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å —á–∏—Å–ª–æ–º –Ω–∞–¥ —Å—Ç–æ–ª–±—Ü–æ–º
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;
            context.fillStyle = '#ffffff';
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = '#000000';
            context.font = '16px Arial';
            context.textAlign = 'center';
            context.fillText(height.toString(), canvas.width / 2, canvas.height / 2 + 5);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Sprite(spriteMaterial);
            
            sprite.position.x = (index - 1) * 0.4;
            sprite.position.y = scaledHeight + 0.3;
            sprite.position.z = 0;
            sprite.scale.set(0.5, 0.25, 1);
            
            group.add(sprite);
        }
    });
    
    scene.add(group);
    
    // –û—Å–≤–µ—â–µ–Ω–∏–µ
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 5, 5);
    scene.add(light);
    
    const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
    scene.add(ambientLight);
    
    camera.position.set(2, 2, 3);
    camera.lookAt(0, 0, 0);
    
    // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    
    animate();
}

// OpenStreetMap —Å —Ç–æ—á–∫–∞–º–∏ –∂–∞–ª–æ–± (—Ñ–æ–∫—É—Å –Ω–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ)
let map;
let markers = [];

function initOpenStreetMap() {
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∂–∞–ª–æ–± –∏–∑ Django
    const reportsCoords = JSON.parse('{{ reports_coords|escapejs }}');
        
    // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã –Ω–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ
    const kazakhstanCenter = [48.0196, 66.9237];
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    map = L.map('openstreetmap').setView(kazakhstanCenter, 5);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingDiv = document.querySelector('#openstreetmap .loading');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
    
    // –¶–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const markerColors = {
        'CRITICAL': 'red',
        'SECONDARY': 'green',
        'SPAM': 'blue'
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∂–∞–ª–æ–±—ã
    reportsCoords.forEach((report, index) => {
        const marker = L.circleMarker([report.lat, report.lon], {
            radius: 8,
            fillColor: markerColors[report.category] || 'red',
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);
        
        // –°–æ–∑–¥–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
        const popupContent = createPopupContent(report);
        marker.bindPopup(popupContent, {
            maxWidth: 300,
            className: 'custom-popup'
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä
        marker.on('click', function(e) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
            this.openPopup();
        });
        
        markers.push(marker);
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥–æ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –ø–æ–¥ –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ OpenStreetMap
function createPopupContent(report) {
    const statusText = report.is_decided ? '‚úÖ –†–µ—à–µ–Ω–∞' : '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
    const statusColor = report.is_decided ? '#28a745' : '#ffc107';
    const categoryColor = report.category === 'CRITICAL' ? '#ff4444' : 
                         report.category === 'SECONDARY' ? '#44ff44' : '#4444ff';
    
    return `
        <div style="max-width: 300px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #0d6efd; font-size: 1.2rem;">${report.title}</h4>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong>üìã –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> 
                <span style="
                    padding: 3px 8px; 
                    border-radius: 15px; 
                    font-size: 0.8rem; 
                    font-weight: 600;
                    background: ${categoryColor};
                    color: white;
                    margin-left: 5px;
                ">${report.category}</span>
            </div>
            
            <div style="margin-bottom: 10px;">
                <strong>üìÖ –î–∞—Ç–∞:</strong> ${report.created_at}
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>
                <div style="
                    background: #f8f9fa; 
                    padding: 10px; 
                    border-radius: 5px; 
                    margin-top: 5px; 
                    border-left: 3px solid #0d6efd;
                    font-size: 0.9rem;
                    line-height: 1.4;
                ">${report.text}</div>
            </div>
            
            <div style="text-align: center;">
                <span style="
                    padding: 5px 15px; 
                    border-radius: 20px; 
                    font-weight: 600;
                    font-size: 0.9rem;
                    background: ${statusColor};
                    color: ${report.is_decided ? 'white' : '#333'};
                ">${statusText}</span>
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–º—É –æ–∫–Ω—É)
function createModalWindow(report) {
    const statusText = report.is_decided ? '‚úÖ –†–µ—à–µ–Ω–∞' : '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
    const statusColor = report.is_decided ? '#28a745' : '#ffc107';
    
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.95);
        color: #333;
        padding: 30px;
        border-radius: 15px;
        border: 3px solid #0d6efd;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 600px;
        width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;
    
    popup.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #0d6efd; padding-bottom: 10px;">
            <h3 style="margin: 0; color: #0d6efd; font-size: 1.5rem;">${report.title}</h3>
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: #dc3545; 
                color: white; 
                border: none; 
                border-radius: 50%; 
                width: 30px; 
                height: 30px; 
                font-size: 16px; 
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            ">√ó</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong>üìã –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> 
            <span style="
                padding: 4px 12px; 
                border-radius: 20px; 
                font-size: 0.9rem; 
                font-weight: 600;
                ${report.category === 'CRITICAL' ? 'background: #ff4444; color: white;' : report.category === 'SECONDARY' ? 'background: #44ff44; color: #333;' : 'background: #4444ff; color: white;'}
            ">${report.category}</span>
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong>üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${report.created_at}
        </div>
        
        <div style="margin-bottom: 20px;">
            <strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>
            <div style="
                background: #f8f9fa; 
                padding: 15px; 
                border-radius: 8px; 
                margin-top: 8px; 
                border-left: 4px solid #0d6efd;
                line-height: 1.6;
            ">${report.text}</div>
        </div>
        
        <div style="text-align: center; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <span style="
                padding: 8px 20px; 
                border-radius: 25px; 
                font-weight: 600;
                background: ${statusColor};
                color: ${report.is_decided ? 'white' : '#333'};
            ">${statusText}</span>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: #0d6efd; 
                color: white; 
                border: none; 
                border-radius: 25px; 
                padding: 10px 25px; 
                font-size: 1rem; 
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#0d6efd'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        cursor: pointer;
    `;
    overlay.onclick = () => {
        popup.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);
}

// –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–¥–æ–≤
function createTrendChart() {
    const ctx = document.getElementById('trend-chart').getContext('2d');
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
    if (window.trendChart) {
        window.trendChart.destroy();
    }
    
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
    let labels, data;
    const period = '{{ period }}';
    
    switch(period) {
        case 'day':
            labels = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'];
            data = [totalCount * 0.3, totalCount * 0.1, totalCount * 0.8, totalCount * 1.2, totalCount * 1.0, totalCount * 0.6, totalCount * 0.4];
            break;
        case 'week':
            labels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            data = [totalCount * 0.8, totalCount * 1.2, totalCount * 0.9, totalCount * 1.1, totalCount * 1.3, totalCount * 0.7, totalCount * 0.5];
            break;
        case 'month':
            labels = ['–ù–µ–¥ 1', '–ù–µ–¥ 2', '–ù–µ–¥ 3', '–ù–µ–¥ 4'];
            data = [totalCount * 0.7, totalCount * 1.1, totalCount * 0.9, totalCount * 1.3];
            break;
        case 'year':
            labels = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
            data = [
                totalCount * 0.8, totalCount * 0.9, totalCount * 1.1, totalCount * 1.0,
                totalCount * 1.2, totalCount * 1.3, totalCount * 0.7, totalCount * 0.6,
                totalCount * 1.1, totalCount * 1.4, totalCount * 0.8, totalCount * 0.9
            ];
            break;
        default:
            labels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            data = [totalCount * 0.8, totalCount * 1.2, totalCount * 0.9, totalCount * 1.1, totalCount * 1.3, totalCount * 0.7, totalCount];
    }
    
    window.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ñ–∞–ª–æ–±—ã',
                data: data,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#0d6efd',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        create3DPieChart();
        create3DBarChart();
        createTrendChart();
        initOpenStreetMap(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenStreetMap
    }, 500);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', function() {
    setTimeout(() => {
        create3DPieChart();
        create3DBarChart();
        // Google Maps –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ä–∞–∑–º–µ—Ä–∞
    }, 100);
});
</script>
{% endblock content %}